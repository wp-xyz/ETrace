# ETrace - Electron Tracer
![grafik](https://github.com/wp-xyz/ETrace/assets/30792460/04a6d097-3d41-467a-aa41-2d77e5c86cc9)

ETrace is a simulation project developed using Free Pascal and Lazarus, designed to trace electron trajectories and simulate Auger electron emission from various sample geometries.

## Project Overview

This section provides a high-level description of the ETrace project, its purpose, and its main components.

ETrace is a simulation software built with Free Pascal and Lazarus. Its primary objective is to model and visualize the interaction of primary electrons with various material samples, specifically focusing on the generation and emission of Auger electrons. The simulation employs Monte Carlo methods to trace the trajectories of electrons within the material, accounting for scattering and energy loss processes.

The project provides a graphical user interface (GUI) that allows users to:
- Configure the parameters of the electron gun (energy, beam diameter, focus).
- Define the characteristics and geometry of the sample, including substrate and layer materials, layer thickness, and topography (contact hole, stripe, step).
- Specify the type and acceptance criteria of the electron analyzer.
- Run simulations based on the defined parameters.
- Visualize the results, such as the emission points of Auger electrons and selected electron trajectories.
- View a summary of the simulation results, including total and spatially resolved Auger intensities.

The core simulation logic is implemented in Pascal units, while the GUI is built using the Lazarus Component Library (LCL), as seen in `etracer.lpr` and `src/et_main.pas`. The `.lfm` file (`src/et_main.lfm`) describes the layout and properties of the GUI elements.

## Coordinate System

Understanding the coordinate system is essential for setting up simulations accurately and interpreting the resulting data, particularly the positions of emission points and trajectories.

ETrace uses a standard **right-handed 3D Cartesian coordinate system** (X, Y, Z). The orientation of the axes and the location of the origin are consistently applied across all calculations and visualizations, primarily defined relative to the sample surface.

*   **Z-axis**: The positive Z-axis always points **upwards**, perpendicular to the primary sample surface (the "top" surface for flat or structured samples). This axis represents the sample normal. Negative Z values extend downwards into the sample bulk. The global variable `SimParams.zAxis` is explicitly set to (0.0, 0.0, 1.0) representing this upward direction.

*   **X-axis and Y-axis**: These axes define the plane of the primary sample surface (the XY-plane). The orientation of the X and Y axes within this plane depends slightly on the chosen sample topography, but they always form a right-handed system with the Z-axis.
    - For **flat samples** (implicitly handled as a special case or ttNone/default plane), the XY plane is the surface.
    - For **Contact Hole** (`ttContactHole`): The origin (0,0,0) is typically at the center of the contact hole opening on the top surface (Z=0). The X and Y axes define the lateral extent of this surface. The contact hole extends downwards (negative Z) to the defined `Depth`.
    - For **Stripe** (`ttStripe`): The origin (0,0,0) is typically at the center of the stripe on the top surface (Z=0). The stripe runs along the **Y-axis**. Its width is defined along the X-axis, centered at X=0. The stripe's height extends downwards (negative Z) to the defined `Height`.
    - For **Step** (`ttStep`): The origin (0,0,0) is typically located at the step edge on the top level (Z=0). The step edge runs along the **Y-axis**. The X-axis is perpendicular to the edge, defining the transition direction. Depending on the `StepDir` (`sdUp` or `sdDown`), either the region with X > 0 or X < 0 will be at a lower Z coordinate (the `Height` value, which is negative).

*   **Origin (0,0,0)**: As described above, the origin is typically located on the primary sample surface (Z=0) and serves as a reference point, often coinciding with a key feature like the center of a hole/stripe or the edge of a step.

**Relation to Beam and Analyzer Orientation:**

*   **Electron Beam**: The primary electron beam is generated by the `TElectronSource`. Its initial direction is defined by a `TiltAngle` relative to the positive Z-axis (sample normal). An azimuthal angle is also implicitly defined during creation (hardcoded to 0.0, meaning the beam is initially in the XZ-plane, incident from the X>0 side if TiltAngle > 0). The beam is focused towards a specified `Focus` point (`TSimParams.Focus`), given in the sample's (X,Y,Z) coordinate system.
*   **Analyzer**: The electron analyzer's acceptance axis is defined by a `PolarAngle` relative to the positive Z-axis and an `AzimuthAngle` relative to the positive X-axis in the XY-plane. These angles determine the direction from which emitted electrons are collected.

All coordinates used for emission points (`FEmissionPoints`), trajectories (`FTrajectories`), and sample dimensions (`Width`, `Depth`, `LayerThickness`) are specified and calculated within this consistent (X, Y, Z) framework. The visualization charts (`EmissionPointsChart`, `TrajectoriesChart`) also use these coordinates, with selectable 2D projections (XY, XZ, YZ) allowing different views of the 3D space.

## Core Concepts and Data Structures

Understanding the fundamental data types and concepts is crucial for comprehending the simulation logic. This section details the key records and types defined in `et_global.pas` and used throughout the project.

*   **Float**: Defined as `double`. This specifies that floating-point numbers are stored with double precision, important for numerical accuracy in the simulation calculations.

*   **TDataType**: An enumeration (`(dtNone, dtTraj, dtEmPts)`) used to classify different types of simulation data, such as trajectories (`dtTraj`) and emission points (`dtEmPts`).

*   **TTopoType**: An enumeration (`(ttNone, ttContactHole, ttStripe, ttStep)`) representing the different sample topographies supported by the simulation.
    - `ttContactHole`: Models a contact hole geometry.
    - `ttStripe`: Models a long stripe or line.
    - `ttStep`: Models a step-like topography.

*   **TAnalyzerType**: An enumeration (`(atNone, atCMA, atCHA)`) defining the types of electron analyzers that can be simulated.
    - `atCMA`: Cylindrical Mirror Analyzer.
    - `atCHA`: Concentric Hemispherical Analyzer.

*   **TNormIntensType**: An enumeration (`(niRaw, niPrimEl, niArea)`) related to intensity normalization methods, although its usage might be limited or specific within the current code. (Based on code analysis, this enum seems unused in the provided units).

*   **TProjection**: An enumeration (`(XYproj, XZproj, YZproj, ThreeD)`) used primarily for selecting the projection plane for visualizing trajectories in the GUI.

*   **TStepDir**: An enumeration (`(sdNone, sdUp, sdDown)`) specifying the direction of a step topography (whether the higher level is 'up' or 'down' relative to the coordinate system, relative to the X-axis position).

*   **TVector3**: A record type representing a 3D vector or point in space with `X`, `Y`, and `Z` components of type `Float`. Used extensively for positions, directions, and other vector quantities.

*   **TRay**: A record combining a starting `Point` (TVector3) and a `Dir`ection (TVector3), used to represent the path of an electron.

*   **TMatrix3**: A record representing a 3x3 matrix, defined as an array of three `TVector3`. While declared, its direct usage in the provided code snippets isn't immediately apparent, suggesting it might be used in other parts of the project or is a leftover.

*   **ExtStr**: A short string type (`String[4]`), possibly used for specific fixed-length identifiers or codes.

*   **Error Codes**: Constants like `etOK`, `etIOError`, `etOutOfMemory`, `etAborted` define a simple error reporting mechanism via the `etError` global variable and `GetError` function.

*   **TSimParams**: A comprehensive record containing all the parameters required to define a simulation run. This includes:
    - `zAxis`: Defines the orientation of the sample surface normal (hardcoded to (0,0,1)).
    - Electron source parameters (`PrimaryEnergy`, `BeamDiameter`, `Focus` point in (X,Y,Z), `NumElectrons`).
    - Electron analyzer parameters (`AnalyzerType`, `SectorStart`, `SectorEnd`, `UseHoeslerAperture`).
    - Sample parameters (`SubstrateName`, `LayerName`, `Topography`, `Width`, `Depth`, `LayerThickness`, `StepDir`, `OnlyDirect`, `TiltAngle` of the beam).
    The `DefaultSimParams` constant provides a baseline configuration. This record acts as the central hub for transferring settings from the GUI (`et_main.pas`, `et_main.lfm`) to the simulation engine (`et_sim.pas`).

These data structures provide the foundation for representing the physical system being simulated and managing the simulation state and parameters.

## Simulation Model

The heart of ETrace lies in its simulation engine, primarily implemented in `et_objects.pas` and `et_sim.pas`. It employs a Monte Carlo approach to simulate the complex interactions of electrons with the sample material.

Key aspects of the simulation model include:

1.  **Electron Source (`TElectronSource`)**:
    - Generates primary electrons with a specified `PrimaryEnergy` (keV) and `BeamDiameter` (µm).
    - Electrons are focused towards a defined `Focus` point (`TVector3`) on the sample surface, specified in the sample's (X,Y,Z) coordinate system.
    - The beam can be tilted relative to the sample normal (positive Z-axis) using the `TiltAngle` (degrees). The azimuthal angle of the primary beam is fixed to 0 degrees (in the XZ plane).
    - The `GenerateElectron` procedure creates individual primary electrons with their initial position (`Ray.Point`) and direction (`Ray.Dir`), incorporating a normal distribution spread (`BeamRadius`) around the `FocusedPoint`.

2.  **Electron-Material Interaction (`TMaterial`)**:
    - The `TMaterial` class encapsulates the physical properties of different materials (e.g., Si, SiO2, Au) relevant to electron interactions.
    - It stores fundamental parameters like `AtomicNumber` (Z), `A` (Atomic/Molecular Mass), `MassDensity` (g/cm³), `CoreLevelEnergy` (keV), and `AugerEnergy` (eV). These parameters are loaded from the `TMaterialsList`.
    - It provides methods based on established physics models to calculate:
        - `CalcAugerCrossSection(E: float)`: Calculates the ionization cross section for exciting the core level at electron energy `E`, based on the Gryzinski model (Eq. 11 in Ze-jun et al. SIA, 10, 253 (1987)).
        - `CalcAugerEscapeDepth(E: float)`: Calculates the average distance (in µm) an Auger electron with energy `E` can travel within the material before losing energy or being absorbed, based on the Seah & Dench model.
        - `CalcStoppingPower(E: float)`: Calculates the rate at which an electron loses energy (dE/dS) as it travels through the material, for energy `E` (keV), using a modified Bethe equation (See Eli Napchan, p9). The result is in keV/µm.
        - `RutherfordScattParams(E: float, var Sigma, Alpha: Float)`: Calculates the total elastic scattering cross-section (`Sigma` in cm²) and the screening factor (`Alpha`) for energy `E` (keV), based on the Rutherford scattering model with a screening correction (See Eli Napchan, p10). These parameters are used to determine scattering angles and step lengths.

3.  **Sample Geometry and Interaction (`TSample`, `TContactHole`, `TStripe`, `TStep`)**:
    - The `TSample` is an abstract base class defining the common interface and shared logic for sample objects. It is initialized with substrate and layer materials (`TMaterial`), the primary electron `Energy`, and the `LayerThickness`.
    - It manages the `Substrate` and `Layer` materials and the layer-substrate `zInterface` position (negative Z relative to the top surface). It changes the active `Material` (`ChangeMaterial`) based on the electron's current Z-coordinate relative to the `zInterface`.
    - The core interaction logic, specific to the sample's shape, is handled by methods that must be implemented by derived classes:
        - `OnSurface(Point: TVector3)`: Returns `True` if the given `Point` is on the sample surface, considering the geometrical tolerance `FloatEps`.
        - `Outside(Point: TVector3)`: Returns `True` if the given `Point` is outside the sample volume.
        - `Intersection(Ray: TRay, var Point: TVector3, FromOutside: Boolean)`: Calculates the intersection point (`Point`) of an electron `Ray` with the sample surface. It returns `True` if an intersection exists in the positive ray direction. The `FromOutside` parameter indicates whether the ray is approaching the surface from outside the sample volume.
        - `SurfNormal(Point: TVector3, var Normal: TVector3)`: Calculates the surface normal vector (`Normal`) at a given `Point` on the surface.
    - **Derived Classes**: `TContactHole`, `TStripe`, and `TStep` provide concrete implementations of the `TSample` interface for specific geometries, defining their shapes and implementing the intersection and surface normal logic based on planes and cylinders. Dimensions like `Radius`, `Depth`, `Width`, `Height`, and `StepDir` are stored and used here.
    - `EmitAugerEl(Point: TVector3, E: float, var Electron: TAugerElectron)`: Simulated Auger electron emission occurs when a primary or scattered electron arrives at a surface `Point` with sufficient energy (`E >= Material.CoreLevelEnergy`). The emission direction (`Electron.Ray.Dir`) is randomized isotropically into the upper hemisphere defined by the surface normal. The contribution of the emitted Auger electron to the overall intensity in the detector (`Electron.Weight`) depends on the material's ionization cross-section, escape depth, emission angle relative to the surface normal, and a normalization factor (`Intensfact`). `GenByBkScEl` flag indicates if the Auger electron was generated by a backscattered electron (i.e., energy E is less than the initial PrimaryEnergy).
    - `Scatter(var Electron: TElectron, var E: float)`: Implements the Monte Carlo step for electron elastic scattering. Based on the current electron `Energy` and the `Material` properties (`RutherfordScattParams`, `StoppingPowerParam`), it calculates a new direction and energy after traveling a simulated step distance (`step`). The step length is determined probabilistically based on the total scattering cross-section. Energy loss is calculated based on the step length and stopping power. The scattering angle distribution is based on the screened Rutherford model.

4.  **Electron Trajectory Calculation (`TSimulation.CalcTrajectory`)**:
    - This procedure traces the path of a single electron (primary or scattered) step-by-step within the sample using the `FSample.Scatter` method.
    - At each step, it checks if the electron has crossed the layer-substrate interface (`zIntf`) and updates the active `Material` accordingly.
    - It checks for intersections with the sample boundary (`FSample.Outside`) and records the exit point if the electron leaves the sample (`ExitsSample`).
    - If the electron is on the surface (`FSample.OnSurface`) and has sufficient energy (`E >= Material.CoreLevelEnergy`), it triggers the `EmitAugerEl` process.
    - The trajectory points (position `TVector3` and `Energy`) are stored in a `TTrajectory` array if `OnTrajectoryComplete` is assigned.
    - The tracing continues until the electron's energy drops below a minimum threshold (`EMin`, typically related to the CoreLevelEnergy) or it leaves the sample (`ExitsSample`). If it exits, `TraceElectron` may call `CalcTrajectory` again for the backscattered electron's trajectory.

5.  **Analyzer (`TAnalyzer`)**:
    - Represents the electron analyzer used to detect Auger electrons emitted from the sample.
    - Configured by `AnalyzerType` (`atCMA` or `atCHA`) and its orientation (`PolarAngle`, `AzimuthAngle` in degrees) relative to the sample's coordinate system.
    - The `Detect(var Electron: TAugerElectron)` method checks if an emitted Auger electron's trajectory (`Electron.Ray.Dir`) falls within the analyzer's defined angular acceptance range. This range is defined by `FAcc1` and `FAcc2` (cosine values of the polar acceptance angles).
    - Optional features like the `UseHoeslerAp` (rejecting electrons emitted at angles less than 80 degrees from the sample normal) and `Restrict`ed azimuthal acceptance (`ASectorFrom`, `ASectorTo` in degrees) can be applied.
    - It accumulates the total `Detected` count and the sum of detected electron `Intensity` (weights).

The `TSimulation` class orchestrates the entire process. Its `Execute(AMaxPrimElectrons: Integer)` method generates `AMaxPrimElectrons` primary electrons from the `FElectronSource` and calls `TraceElectron` for each. `TraceElectron` manages the primary electron's initial interaction and calls `CalcTrajectory`. If a primary electron exits the sample (backscatters), `TraceElectron` may call itself recursively (up to a limit of 10 secondary electron traces) to trace the backscattered electron, allowing for Auger emission generated by backscattered electrons. Event handlers (`OnCancel`, `OnDetection`, `OnTrajectoryComplete`) allow the GUI to receive updates during the simulation. The `SampleHitPoint` property calculates where a primary electron aimed at the `Focus` point would initially intersect the sample surface.

## User Interface and Parameters

The ETrace application provides a graphical user interface (GUI) built with Lazarus (described in `src/et_main.lfm`) to configure and run simulations. The main form (`TMainForm` in `src/et_main.pas`) is organized into several sections within the `ParamsPanel` for parameter input and the `ResultsPageControl` for output visualization.

### Parameters Panel (`ParamsPanel`)

This panel contains group boxes for configuring the simulation settings:

#### Electron Gun Parameters (`gbEGun`)

This group box contains controls related to the primary electron beam:

*   **Primary electron count (`sePrimElCount`)**: A spin edit for specifying the total number of primary electrons to simulate. Corresponds to `TSimParams.NumElectrons`. Maximum value is limited by `MaxInt`.
*   **Primary energy (keV) (`sePrimEnergy`)**: A float spin edit to set the energy of the primary electron beam in keV. Corresponds to `TSimParams.PrimaryEnergy`. Range is 1 to 100 keV.
*   **Beam diameter (µm) (`seBeamDiam`)**: A float spin edit for the diameter of the electron beam at the focus point in micrometers. Corresponds to `TSimParams.BeamDiameter`. Range is 0.1 to 10 µm.
*   **Focus X, Y, Z (µm) (`seFocusX`, `seFocusY`, `seFocusZ`)**: Float spin edits to define the (X, Y, Z) coordinates in micrometers where the electron beam is focused on the sample, relative to the sample's coordinate system origin. Corresponds to `TSimParams.Focus`. Minimum value is 0.1 µm.

#### Analyzer Parameters (`gbAnalyzer`)

This group box controls the settings of the simulated electron analyzer:

*   **Type (`cmbAnalyzerType`)**: A combo box to select the analyzer type: 'CMA' (Cylindrical Mirror Analyzer) or 'CHA' (Concentric Hemispherical Analyzer). Corresponds to `TSimParams.AnalyzerType` (`atCMA` or `atCHA`).
*   **Annular aperture (`cbAnnularAperture`)**: A checkbox. When checked, it enables the 'from' and 'to' angle inputs for restricting the azimuthal acceptance of the analyzer. Note that azimuthal restriction is only supported for CMA (`atCMA`). This likely influences the use of `TSimParams.SectorStart` and `TSimParams.SectorEnd`.
*   **from, to (deg) (`seSectorFrom`, `seSectorTo`)**: Float spin edits to define the start and end angles (in degrees) for the annular (azimuthal) aperture range. Only enabled when 'Annular aperture' is checked and the analyzer type is CMA. These correspond to `TSimParams.SectorStart` and `TSimParams.SectorEnd`. Range is 0 to 360 degrees.
*   **Hösler aperture (> 80 deg) (`cbUseHoeslerAp`)**: A checkbox to enable the Hösler aperture. This restricts detected electrons to those emitted at angles greater than 80 degrees from the positive Z-axis (sample normal). Only applicable for CMA. Corresponds to `TSimParams.UseHoeslerAperture`.

#### Sample Parameters (`gbSample`)

This group box defines the material and geometry of the sample:

*   **Tilt angle (deg) (`seTiltAngle`)**: A float spin edit to set the tilt angle of the sample relative to the electron beam axis (which is initially along +Z in the beam's frame). This angle is measured from the sample's positive Z-axis (normal). Corresponds to `TSimParams.TiltAngle`. Range is -90 to 90 degrees.
*   **Substrate material (`cmbSubstrate`)**: A combo box listing available substrate materials. The list is populated from the names found in the hardcoded `TMaterialsList` in `et_objects.pas`. Corresponds to `TSimParams.SubstrateName`. Available materials are currently: Al, Si, SiO2, Fe, Au, Cu, Ni, Pt, Ag, Cr, Mo.
*   **Layer material (`cmbLayer`)**: A combo box listing available layer materials. Also populated from `TMaterialsList`. Corresponds to `TSimParams.LayerName`. Available materials are the same as for the Substrate.
*   **Layer thickness (µm) (`seLayerThickness`)**: A float spin edit for the thickness of the layer in micrometers, measured downwards from the Z=0 surface. A value of -1 indicates the layer thickness is assumed to be equal to the feature depth/height for topographical samples (`SimParams.LayerThickness := -abs(ALayerThickness)` in `TSample.Create`, then adjusted in derived classes). Corresponds to `TSimParams.LayerThickness`. Minimum value is -1, maximum is 999999 µm.
*   **Topography (`cmbTopography`)**: A combo box to select the sample geometry: 'Contact hole', 'Stripe', or 'Step'. These options correspond to `ttContactHole`, `ttStripe`, and `ttStep` respectively. Corresponds to `TSimParams.Topography`.
    - Depending on the selected topography (`cmbTopographyChange` procedure), the labels and enabled state of the 'Depth', 'Width', and 'Direction' controls change to reflect the relevant parameter names for that geometry.
*   **Depth (µm) (`seDepth`)**: A float spin edit. Represents the depth of the contact hole or the height of the stripe/step in micrometers (always stored as a negative Z value internally in sample classes). Corresponds to `TSimParams.Depth`. Minimum value is -1, maximum is 999999 µm.
*   **Width (µm) (`seWidth`)**: A float spin edit. Represents the diameter of the contact hole or the width of the stripe in micrometers. This control is disabled for the 'Step' topography. Corresponds to `TSimParams.Width`. Minimum value is -1, maximum is 999999 µm.
*   **Direction (`sbDirUp`, `sbDirDown`)**: Speed buttons to specify the direction of the step (`sdUp` or `sdDown`). Only enabled for the 'Step' topography. These correspond to `TSimParams.StepDir`.

### Simulation Control

*   **Run simulation (`btnRunSim`)**: A button to start the simulation. When clicked, it reads parameters from the GUI (`GUIToParams`), prepares the simulation (`PrepareSim`), and calls `RunSimulation`. The caption changes to 'Abort' while running (`FRunning` flag), allowing the user to interrupt the simulation by setting `FAborted`.
*   **ProgressBar (`ProgressBar`)**: Displays the simulation progress based on the number of primary electrons processed (`ASimulation.ElectronSource.NumFired`), visible when the simulation is running. Updated via the `CancelHandler` procedure.
*   **Trajectory count (`seTrajectories`)**: A spin edit (located in the Trajectories tab) to limit the number of individual electron trajectories that are stored and displayed. The simulation stops recording trajectories once this count is reached (`TrajectoryCompleteHandler`).

The GUI elements are connected to event handlers in `et_main.pas` which manage the flow: reading parameters (`GUIToParams`), initializing and running the simulation (`RunSimulation`), updating control states (`UpdateCtrlState`), handling simulation events (`CancelHandler`, `DetectionHandler`, `TrajectoryCompleteHandler`), and displaying results (`DisplaySummary`, `EmissionPointsSourceGetChartDataItem`, `TrajectoryGetChartDataItemHandler`). User interface settings (window position, active tabs, chart extents) and simulation parameters are saved to and loaded from an INI configuration file (`etracer.ini` and `etracer.cfg` respectively) using `ReadIni`/`WriteIni` and `LoadParamsFromCfg`/`SaveParamsToCfg`.

## Simulation Results and Visualization

After a simulation run completes, the results are displayed in the `ResultsPageControl` area of the main form (`et_main.lfm`). This control has several tabs:

### Summary (`pgSummary`)

*   **Summary Memo (`SummaryMemo`)**: This memo displays a textual summary of the simulation parameters used and the key results.
    - Parameters listed include details about the electron source (energy, beam diameter, focus, incident angle - derived from `TiltAngle`), the analyzer (type, restricted acceptance, Hösler aperture), and the sample (materials, topography, dimensions, tilt angle - which is the same as the beam incident angle).
    - Results presented include the total number of primary electrons fired, the total number of detected Auger electrons, the total detected intensity (sum of electron weights), and the intensity contributions from different surface regions (top, bottom, sidewall), where applicable based on topography. This intensity breakdown is calculated by the `EvalIntensities` procedure in `et_main.pas` based on the emission point coordinates and the sample geometry defined by the `SimParams`.
    - The `DisplaySummary` procedure in `et_main.pas` is responsible for formatting and populating the content of this memo.

### Emission Points (`pgEmissionPoints`)

This tab visualizes and lists the surface points from which Auger electrons were emitted and detected by the analyzer. It has two sub-tabs:

*   **Plot (`pgPlot`)**:
    - **Emission Points Chart (`EmissionPointsChart`)**: A 2D chart displaying the (X, Y) coordinates of the detected Auger electron emission points on the sample surface. The X and Y axes represent the lateral dimensions in micrometers, consistent with the sample coordinate system.
    - **Emission Points Series (`EmissionPointsSeries`)**: A scatter series (`TLineSeries` with `LineType = ltNone` and visible circular pointers) used to draw the individual emission points on the chart. Each point represents the (X, Y) coordinate of a detected Auger electron's emission location.
    - **Emission Points Source (`EmissionPointsSource`)**: A `TUserDefinedChartSource` which provides the data (X, Y coordinates) for the `EmissionPointsSeries` by calling the `EmissionPointsSourceGetChartDataItem` procedure in `et_main.pas`. This procedure retrieves the X and Y coordinates from the `FEmissionPoints` array, which stores `TVector3` points.
    - **Horizontal Extent Spin Edits (`seEmissionPointsHorMin`, `seEmissionPointsHorMax`)**: Float spin edits that allow the user to control the visible range of the X-axis on the Emission Points Chart. The chart's Y-axis range is adjusted proportionally (`Proportional = True`) to maintain the aspect ratio, assuming X and Y scales are equal. The `EmissionPointsChartExtentChange` procedure handles updates to the chart's `Extent`.
    - The simulation collects all detected Auger electron emission points in the `FEmissionPoints` array (`DetectionHandler` in `et_main.pas`).

*   **Values (`pgValues`)**:
    - **Emission Points Memo (`EmissionPointsMemo`)**: A memo displaying the raw data for each detected Auger electron, including its sequence number, emission point coordinates (X, Y, Z), and the calculated intensity contributions from different surface regions (Top, Wall, Bottom) based on the `EvalIntensities` function. It also indicates if the electron was generated by a backscattered electron ('X' in the 'BkSc' column) using the `GenByBkScEl` flag. The format is defined by the `TITLE_MASK` and `VALUE_MASK` constants in `et_main.pas`.
    - The `DetectionHandler` procedure in `et_main.pas` formats and adds each detected electron's data as a new line in this memo.

### Trajectories (`pgTrajectories`)

This tab allows visualization of the paths taken by a limited number of primary and scattered electrons within and around the sample. It includes controls for selecting the view and limiting the number of trajectories.

*   **Trajectory Count (`seTrajectories`)**: A spin edit to set the maximum number of individual electron trajectories to display. The simulation will only record and provide the first `seTrajectories.Value` trajectories that complete their path (either by exiting the sample or dropping below the minimum energy).
*   **Projection Radio Group (`rgProjection`)**: A radio group to select the 2D projection plane for viewing the 3D trajectories: 'X-Y plane', 'X-Z plane', or 'Y-Z plane'. Corresponds to the `TProjection` enumeration (`XYproj`, `XZproj`, `YZproj`). The `rgProjectionClick` procedure updates the chart axes titles (`TrajectoriesChart.LeftAxis.Title.Caption`, `TrajectoriesChart.BottomAxis.Title.Caption`) according to the selected projection and signals the chart sources to reset and redraw.
*   **Trajectories Chart (`TrajectoriesChart`)**: A chart where the electron trajectories are drawn.
    - Each individual trajectory that is recorded by the simulation (`CalcTrajectory` and `TraceElectron`) is added as a separate `TLineSeries` to this chart.
    - Each series uses a `TUserDefinedChartSource` to retrieve the trajectory points (`TTrajectory`). The `TrajectoryCompleteHandler` event handler in `TSimulation` (if assigned) triggers the creation of these series when a trajectory finishes tracing. The `TrajectoryGetChartDataItemHandler` procedure in `et_main.pas` retrieves the appropriate (X, Y) pair from the `TTrajectoryPoint` array based on the selected `rgProjection`.
    - The chart's axes titles change based on the selected `rgProjection`.
    - **Horizontal Extent Spin Edits (`seTrajectoryHorMin`, `seTrajectoryHorMax`)**: Similar to the Emission Points chart, these controls allow adjusting the visible range of the horizontal axis. `TrajectoriesChartExtentChange` handles these updates. The vertical axis is scaled proportionally.
    - **`TrajectoriesChartAfterDraw`**: This procedure is triggered after the series are drawn. It is used to draw an outline of the sample geometry (contact hole, stripe, or step) and the initial electron beam path (aimed at `FSampleHitPoint`) on top of the trajectories, providing visual context within the selected projection plane. The geometry outline is drawn in red, and the electron beam path (from an arbitrary point outside the sample to the `SampleHitPoint`) in blue.

## Building and Running

The ETrace project is developed using Free Pascal and Lazarus. To build and run the application from source, you need to have these tools installed on your Ubuntu system (or other supported platforms).

1.  **Install Free Pascal and Lazarus**:
    If you don't have them installed, you can typically install them using your system's package manager:
    ```bash
    sudo apt update
    sudo apt install fpc laz Lazarus
    ```

2.  **Open the Project in Lazarus**:
    - Launch the Lazarus IDE.
    - Go to `Project -> Open Project File...`.
    - Navigate to the directory where you have the ETrace source code and select the main project file, `etracer.lpr`.

3.  **Configure Project Settings (if necessary)**:
    - Lazarus should automatically configure the project based on the `.lpr` file.
    - Ensure the compiler path is correctly set (usually detected automatically).
    - The project requires the `tachartlazaruspkg` and `lazcontrols` packages. Check the project dependencies in `Project -> Project Options... -> Packages`. If any required package is not installed in your Lazarus environment, you may need to install it via `Package -> Install/Uninstall Packages...`. These packages are usually available through the Lazarus Online Package Manager (OPM) or your distribution's repositories.
    - The units `et_Main`, `et_Math`, `et_Global`, `et_Objects`, and `et_Sim` should be automatically included as they are in the project's source path or explicitly listed in the `.lpr` file's `uses` clause.

4.  **Build the Project**:
    - Go to `Run -> Build` or press `Shift+F9`.
    - Lazarus will compile the Pascal units and link the executable. Any compilation errors will be shown in the Messages window.

5.  **Run the Application**:
    - Go to `Run -> Run` or press `F9`.
    - Lazarus will execute the compiled application.

The executable file (`etracer` on Linux) will be created in the project's main directory or a designated output directory configured in the Project Options.

The project also includes unit tests located in the `unit_tests/` directory (`unit_tests/et_tests.lpr`, `unit_tests/etmathtests.pas`, `unit_tests/etsampletests.pas`). These tests are designed to be run using a GUI test runner (`TGuiTestRunner`), likely included with Lazarus or the fpcunit package. You can typically run these tests by opening `unit_tests/et_tests.lpr` in Lazarus and running that project.

## Potential Applications

The ETrace simulation project, while potentially a research or educational tool, can be applied to solve problems in various fields where electron-sample interactions and surface analysis are important. By simulating the physics of electron-sample interactions and Auger electron emission, ETrace can provide valuable insights that complement experimental work.

Possible applications include:

1.  **Auger Electron Spectroscopy (AES) Analysis**:
    - **Interpreting Spectra from Topographical Samples**: Real-world samples often have complex 3D features (lines, holes, steps, roughness). The intensity of Auger electrons detected from such features is heavily influenced by the local surface orientation relative to the electron beam and the analyzer, as well as by electron scattering within the material. ETrace can simulate the Auger signal from known geometries and material compositions under specific experimental conditions (beam energy, tilt, analyzer type/angle), helping experimentalists understand how topography affects measured intensities and aiding in accurate compositional analysis.
    - **Quantitative Analysis**: By comparing simulated Auger intensities from different regions of a topographical sample to experimental line scans or maps, it may be possible to perform more accurate quantitative elemental analysis than is possible with models that assume flat surfaces.
    - **Signal Origin**: Visualizing electron trajectories and emission points helps understand *where* the detected Auger electrons are originating from, which is crucial for interpreting spatial resolution and depth sensitivity in AES measurements on structured samples.

2.  **Scanning Electron Microscopy (SEM)**:
    - **Image Contrast Interpretation**: While ETrace focuses on Auger electrons, the underlying simulation of primary and scattered electron trajectories is relevant to SEM imaging. The yield of backscattered electrons, for instance, contributes significantly to SEM image contrast, especially for compositional and topographical contrast. ETrace's ability to track primary electron paths and identify where they exit the sample could provide insight into backscattering yield variations on different topographies and materials.
    - **Electron-Beam Induced Effects**: Understanding the penetration depth and scattering volume of the primary electron beam is important for minimizing beam-induced damage or charging in sensitive samples. The trajectory simulations provide a visual representation of the interaction volume.

3.  **Electron Beam Lithography**:
    - **Proximity Effect**: Electron scattering within the resist layer and backscattering from the substrate are primary causes of the proximity effect in electron beam lithography, where features are overexposed by electrons scattered from adjacent exposed areas. While ETrace's focus is not specifically on energy deposition in resist, the core scattering simulation could potentially be adapted or used to generate scattering kernels that inform proximity effect correction strategies for patterned substrates.

4.  **Materials Science Research**:
    - **Investigating Surface Sensitivity**: Simulating emission from varying depths and materials can help researchers understand and visualize the surface sensitivity of AES for specific material systems and electron energies.
    - **Novel Materials and Structures**: ETrace provides a flexible platform to investigate electron interactions with new materials (once their relevant parameters are added to the `TMaterialsList`) or complex layered/structured systems.

5.  **Education and Training**:
    - **Visualization Tool**: The trajectory visualization is a powerful educational tool for demonstrating the principles of electron scattering (elastic and inelastic), energy loss, interaction volume, and the origin of Auger electrons in solids. It can help students grasp complex concepts in surface science, materials analysis, and electron microscopy.

By providing a computational model of electron-sample interactions, ETrace enables predictive simulations that can guide experimental design, aid in data interpretation, and deepen the understanding of fundamental electron-solid physics relevant to various scientific and technological fields.

## Source Code Structure

The ETrace project is organized into several files and directories, promoting modularity and separation of concerns:

*   `etracer.lpr`: The main project file for the Lazarus IDE. It defines the program entry point (`begin ... end.`) and lists the primary units used directly by the application's main program, specifically the LCL interface units and the main form unit (`et_Main`).
*   `README.md`: The top-level README file (this documentation).
*   `src/`: This directory contains the core Pascal units (`.pas`) and the Lazarus form definition files (`.lfm`).
    *   `src/et_global.pas`: Defines global constants, enumerations (`TDataType`, `TTopoType`, `TAnalyzerType`, `TNormIntensType`, `TProjection`, `TStepDir`), fundamental record types (`TVector3`, `TRay`, `TSimParams`), and global variables (`etError`, `SimParams`). It establishes the basic data structures and global state for the simulation.
    *   `src/et_math.pas`: Contains mathematical functions and vector operations (`TVector3` and `TRay` operators and functions) essential for 3D geometry and physics calculations. This includes coordinate conversions (Cartesian, Spherical, Cylindrical) and geometric intersection routines (`rayXplane`, `rayXcyl`). It also provides functions for solving quadratic equations and generating random numbers with specific distributions (`Random_Gauss`, `Random_Cos`).
    *   `src/et_objects.pas`: Defines the main object-oriented components of the simulation: `TElectron` (record), `TAugerElectron` (record), `TElectronSource` (class for beam generation), `TAnalyzer` (class for electron detection), `TMaterialParams` (class for material properties data storage), `TMaterialsList` (class for managing material parameters), `TMaterial` (class for material properties and interaction calculations), and the `TSample` class hierarchy (`TSample` - abstract base, `TContactHole`, `TStripe`, `TStep` - concrete geometries). This unit encapsulates the physics models and geometric definitions.
    *   `src/et_sim.pas`: Implements the core simulation engine logic within the `TSimulation` class. It orchestrates the Monte Carlo tracing of electron trajectories (`CalcTrajectory`, `TraceElectron`), manages the interaction loop, handles material changes based on position, and uses the `TAnalyzer` and `TSample` objects. It defines `TTrajectoryPoint` (record) and `TTrajectory` (array of points) for storing path data and defines event handler types (`TCancelEvent`, `TDetectionEvent`, `TTrajectoryCompleteEvent`).
    *   `src/et_main.pas`: The main form unit. It defines the `TMainForm` class, which manages the graphical user interface (GUI) defined in `et_main.lfm`. It contains the event handlers for all GUI controls (buttons, spin edits, combo boxes, etc.), reads simulation parameters from the GUI (`GUIToParams`), initializes and runs the `TSimulation` object (`RunSimulation`), handles simulation progress and events, and updates the GUI with results (summary, emission points list and chart, trajectory chart). It also handles saving and loading parameters and GUI settings (`LoadParamsFromCfg`, `SaveParamsToCfg`, `ReadIni`, `WriteIni`).
    *   `src/et_main.lfm`: The Lazarus Form file defining the visual layout, properties, and event handler assignments for the `TMainForm` GUI. This is a non-human-readable text representation generated by the Lazarus IDE.
    *   `src/et_params.pas`: A unit that appears to be related to simulation parameters, defining some global variables (`MaxEl`, `TraceName`, `EmPtFName`, etc.) and some unused constants. Based on the provided source, parameter management and configuration file handling are primarily done in `et_main.pas` using the `TSimParams` record and INI files. This unit's role in the currently provided code is minimal or vestigial.
*   `unit_tests/`: This directory contains the unit tests for the project, using the fpcunit testing framework.
    *   `unit_tests/et_tests.lpr`: The main project file for compiling and running the unit tests, likely using a GUI test runner (`TGuiTestRunner`).
    *   `unit_tests/etmathtests.pas`: Contains specific unit tests for the mathematical functions implemented in `et_math.pas`, such as vector operations and intersection calculations (`TestVectorMath`, `TestIntersection_RayPlane`).
    *   `unit_tests/etsampletests.pas`: Contains unit tests for the sample geometry intersection logic implemented in the `TSample` derived classes, specifically testing `Intersection` for `TContactHole` (`TestIntersection_ContactHole`) and `TStripe` (`TestIntersection_Stripe`).

This structure promotes modularity and separation of concerns, with global definitions, mathematical utilities, physical objects, simulation logic, and the user interface residing in distinct units.
